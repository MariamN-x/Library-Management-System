import java.io.Serializable;
import java.util.List;
import java.util.Optional;
import javafx.application.Application;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.geometry.Insets;
import javafx.geometry.Pos;
import javafx.scene.Node;
import javafx.scene.Scene;
import javafx.scene.control.*;
import javafx.scene.image.Image;
import javafx.scene.image.ImageView;
import javafx.scene.layout.FlowPane;
import javafx.scene.layout.GridPane;
import javafx.scene.layout.HBox;
import javafx.scene.layout.StackPane;
import javafx.scene.layout.VBox;
import javafx.stage.Stage;

public class FirstPage extends Application implements Serializable{
    protected static List<User> users;
    protected Stage primaryStage;
    protected TextField usernameField;
    protected PasswordField passwordField;
    protected PasswordField retypePasswordField;
    protected Button login;
    protected Button signup1;
    protected Button signup2;
    protected ObservableList<String> observableList;
    private User accountObj;
    private ComboBox<String> combo;
   
    @Override
    public void start(Stage primaryStage) {
        this.primaryStage = primaryStage;
        primaryStage.setTitle("Library System");
        LoginScene(primaryStage);
        primaryStage.setResizable(false);
        primaryStage.show();

    }
    
protected boolean Login(String username, String password,Stage primaryStage) {
       accountObj = User.login(users, username, password); //user.login in class user
    if (accountObj != null) {
        System.out.println("Login successful!");

        if (accountObj instanceof Admin) {
            primaryStage.setScene(AdminScene());
            return true;
        } else if (accountObj instanceof Librarian) {
            primaryStage.setScene(LibrarianScene());
            return true;
        } else if (accountObj instanceof Borrower) {
            primaryStage.setScene(BorrowerScene());
            return true;
        }
    }
        return false;
    }
protected boolean signup(String username, String password, Stage primaryStage, String selectedItem) {
    if (isUsernameExists(username)) {
        showAlert("Signup Failed!\nUsername ALREADY taken", Alert.AlertType.ERROR);
        return false;
    } else {
        switch (selectedItem) {
            case "Add Admin":
                accountObj = new Admin(username, password);
                users.add(accountObj);
                primaryStage.setScene(AdminScene());
                break;
            case "Add Librarian":
                accountObj = new Librarian(username, password);
                users.add(accountObj);
                primaryStage.setScene(LibrarianScene());
                break;
            default:
                accountObj = new Borrower(username, password);
                users.add(accountObj);
                primaryStage.setScene(BorrowerScene());
                break;
        }
        usernameField.clear();
        passwordField.clear();

        return true;
    }
}

protected boolean isUsernameExists(String username) {
    for (User user : users) {
        if (user.getUserName().equals(username)) {
            return true; 
        }
    }
    return false; 
}

//scenes
protected void LoginScene(Stage primaryStage) {
        Image image = new Image("file:ll.png");
        ImageView imageView = new ImageView(image);
        imageView.setFitWidth(primaryStage.getWidth());
        imageView.setFitHeight(primaryStage.getHeight());

        Label usernameLbl1 = new Label("Username  ");
        usernameLbl1.setStyle("-fx-font-size: 13px; -fx-font-weight: bold; -fx-font-family: 'Georgia';-fx-font-style: italic; -fx-text-fill: white;");
        usernameField = new TextField();
       
        Label passwordLbl = new Label("Password  ");
        passwordLbl.setStyle("-fx-font-size: 13px; -fx-font-weight: bold; -fx-font-family: 'Georgia';-fx-font-style: italic; -fx-text-fill: white;");
        passwordField = new PasswordField();
       
        login = new Button("Login");
        signup1 = new Button("Sign Up");
        login.setStyle("-fx-font-size: 15px; -fx-background-color: gray; -fx-text-fill: white;");
        signup1.setStyle("-fx-font-size: 15px; -fx-background-color: gray; -fx-text-fill: white;");

        FlowPane root1 = new FlowPane(usernameLbl1, usernameField);
        root1.setAlignment(Pos.CENTER);
        root1.setHgap(10);
        root1.setVgap(5);
        root1.setPadding(new Insets(0, 0, 0, 300));

        FlowPane root2 = new FlowPane(passwordLbl, passwordField);
        root2.setAlignment(Pos.CENTER);
        root2.setHgap(10);
        root2.setVgap(5);
        root2.setPadding(new Insets(20, 0, 0, 300));

        FlowPane root3 = new FlowPane(login, signup1);
        root3.setAlignment(Pos.CENTER);
        root3.setHgap(20);
        root3.setPadding(new Insets(30, 0, 0, 400));

        VBox Root = new VBox();
        Root.setAlignment(Pos.CENTER);
        Root.setSpacing(10);
        Root.getChildren().addAll(root1, root2, root3);
        
        StackPane all = new StackPane(imageView, Root);
        Scene scene = new Scene(all, 1000, 800);
        login.setOnAction(e -> {
           String username = usernameField.getText();
           String password = passwordField.getText();
           if (!Login(username, password, primaryStage))
        showAlert("Invalid username or password!", Alert.AlertType.ERROR);
        });

        signup1.setOnAction(e -> {
           primaryStage.setScene(signUpScene());
});

        primaryStage.setScene(scene);
    }
public Scene signUpScene() {
    Image image = new Image("file:ll.png");
    ImageView imageView = new ImageView(image);

    Label usernameLbl1 = new Label("Username  ");
    usernameLbl1.setStyle("-fx-font-size: 13px; -fx-font-weight: bold; -fx-font-family: 'Georgia';-fx-font-style: italic; -fx-text-fill: white;");
    usernameField = new TextField();
    Label passwordLbl = new Label("Password  ");
    passwordField = new PasswordField();
    passwordLbl.setStyle("-fx-font-size: 13px; -fx-font-weight: bold; -fx-font-family: 'Georgia';-fx-font-style: italic; -fx-text-fill: white;");

    Label reTypepasswordLbl = new Label("Re-Type Password");
    retypePasswordField = new PasswordField();
    reTypepasswordLbl.setStyle("-fx-font-size: 13px; -fx-font-weight: bold; -fx-font-family: 'Georgia';-fx-font-style: italic; -fx-text-fill: white;");

    signup2 = new Button("Sign Up");
    signup2.setStyle("-fx-font-size: 15px; -fx-background-color: gray; -fx-text-fill: white;");

    FlowPane root1 = new FlowPane(usernameLbl1, usernameField);
    root1.setAlignment(Pos.CENTER);
    root1.setHgap(80);
    root1.setPadding(new Insets(0, 0, 0, 300));

    FlowPane root2 = new FlowPane(passwordLbl, passwordField);
    root2.setAlignment(Pos.CENTER);
    root2.setHgap(80);
   // root2.setVgap(5);
    root2.setPadding(new Insets(0, 0, 0, 300));

    FlowPane root3 = new FlowPane(reTypepasswordLbl, retypePasswordField);
    root3.setAlignment(Pos.CENTER);
    root3.setHgap(30);
    root3.setVgap(5);
    root3.setPadding(new Insets(0, 50, 0, 350));

    FlowPane root4 = new FlowPane( signup2);
    root4.setAlignment(Pos.CENTER);
    root4.setHgap(20);
    root4.setPadding(new Insets(20, 0, 0, 460));

    VBox Root = new VBox();
    Root.setAlignment(Pos.CENTER);
    Root.setSpacing(10);
    Root.getChildren().addAll(root1, root2, root3, root4);
    StackPane all = new StackPane(imageView, Root);
    Scene scene = new Scene(all, 1000, 800);
    signup2.setOnAction(e -> {
        String username = usernameField.getText();
        String password = passwordField.getText();
        signup(username,password,primaryStage,combo.getSelectionModel().getSelectedItem());
    
    });

    return scene;
}

private Scene AdminScene() {
    Image image = new Image("file:library.jpg");
    ImageView imageView = new ImageView(image);
    
    GridPane grid = new GridPane();
    grid.setAlignment(Pos.TOP_CENTER);
    grid.setVgap(10); 

    Label lbl = new Label("Welcome  " + usernameField.getText() + "  To The Library");
    lbl.setStyle("-fx-font-size: 12px; -fx-font-weight: bold; -fx-font-family: 'Georgia'; -fx-font-style: italic; -fx-text-fill: black;");
    lbl.setPadding(new Insets(20));
//add
    Label addLbl = new Label("\t\t\tAdd");
    addLbl.setStyle("-fx-font-size: 12px; -fx-font-weight: bold; -fx-font-family: 'Georgia'; -fx-font-style: italic; -fx-text-fill: white;");
    ObservableList<String> addOptions = FXCollections.observableArrayList("Add Admin", "Add Librarian", "Add Borrower");
    combo = new ComboBox<>(addOptions);
    combo.setStyle("-fx-background-color: black; -fx-text-fill: white; -fx-pref-width: 200px;-fx-pref-height: 30px;"); 

    combo.setOnAction(e -> {
    String selectedItem = combo.getSelectionModel().getSelectedItem();
    if (selectedItem != null) {
        if (selectedItem.equals("Add Admin") || selectedItem.equals("Add Librarian") || selectedItem.equals("Add Borrower")) {
            Scene signUpScene = signUpScene(); 
            primaryStage.setScene(signUpScene); // show add user dialog**** make method dialog generalized
        }
    }
    });
//edit
    Button editUserButton = new Button("Edit User");
    editUserButton.setStyle("-fx-font-size: 12px; -fx-background-color: #062758; -fx-text-fill: white;");
    editUserButton.setOnAction(e -> showEditUserDialog());
       
    grid.add(lbl, 0, 0);
    grid.add(combo, 0, 2);
    grid.add(addLbl, 0, 2);
    grid.add(editUserButton, 1, 2);
    StackPane stack=new StackPane(imageView,grid);
    Scene newScene = new Scene(stack, 1000, 800);
    return newScene;
}

protected Scene LibrarianScene() {
        
    VBox root=new VBox();   
    root.setAlignment(Pos.CENTER);
    Scene newScene=new Scene(root,700,600);
    
    return newScene;
}

protected Scene BorrowerScene() {
    Label lbl=new Label("Welcome To The Library...\nBorrower");
    lbl.setStyle("-fx-font-size: 21px; -fx-font-weight: bold; -fx-font-family: 'Georgia';-fx-font-style: italic; -fx-text-fill: black;");
    VBox root=new VBox(lbl);   
    root.setAlignment(Pos.CENTER);
    Scene newScene=new Scene(root,700,600);
    
    return newScene;
}

protected boolean editUser(String oldUsername, String newUsername, String newPassword) { //to show dialog or alert
    User userToEdit = new User();
    userToEdit=userToEdit.editUser(users, oldUsername, newUsername, newPassword);// called from user class
    if (userToEdit != null) {
        if (!oldUsername.equals(newUsername) && isUsernameExists(newUsername)) {
            showAlert("Edit Failed!\nNew username is already taken", Alert.AlertType.ERROR);
            return false;
        }
        userToEdit.setUserName(newUsername);
        userToEdit.setPassword(newPassword);
        showAlert("User information updated successfully", Alert.AlertType.INFORMATION);
        return true;
    } else {
        showAlert("User not found", Alert.AlertType.ERROR);
        return false;
    }
}
private void showEditUserDialog() {
    Dialog<String> dialog = new Dialog<>();
    dialog.setTitle("Edit User");
    dialog.setHeaderText("Enter new username and password:");
    ButtonType editButtonType = new ButtonType("Edit", ButtonBar.ButtonData.OK_DONE);
    dialog.getDialogPane().getButtonTypes().addAll(editButtonType, ButtonType.CANCEL);
    TextField newUsernameField = new TextField();
    PasswordField newPasswordField = new PasswordField();
    dialog.getDialogPane().setContent(new VBox(10, new Label("New Username:"), newUsernameField, new Label("New Password:"), newPasswordField));
    Node editButton = dialog.getDialogPane().lookupButton(editButtonType);
    editButton.setDisable(true);
    newUsernameField.textProperty().addListener((observable, oldValue, newValue) -> {
        editButton.setDisable(newValue.trim().isEmpty());
    });
    dialog.setResultConverter(dialogButton -> {
        if (dialogButton == editButtonType) {
            return newUsernameField.getText() + "," + newPasswordField.getText();
        }
        return null;
    });
    Optional<String> result = dialog.showAndWait();
    result.ifPresent(newUserData -> {
        String[] userData = newUserData.split(",");
        String newUsername = userData[0];
        String newPassword = userData[1];
        editUser(usernameField.getText(), newUsername, newPassword);
    });
}
private void showAlert(String message, Alert.AlertType alertType) {
        Alert alert = new Alert(alertType);
        alert.setTitle("Message");
        alert.setHeaderText(null);
        alert.setContentText(message);
        alert.showAndWait();
    }
public static void main(String[] args) {
        users=User.readUsersFromFile("users.bin");
        launch(args);
        Admin.writeUsersToFile(users,"users.bin");       
    }
}
